# SmartMess - Simple Database Setup Guide

## TL;DR - What You Actually Need to Do

1. **Create a `loginCredentials` collection** with student and manager login details
2. **Create a `messes` collection** with 2-3 test messes
3. **Run the app** - everything else auto-generates

---

## Step 1: Manually Create Collections

### Collection 1: `loginCredentials`
This is THE ONLY collection you need to create manually. It stores login credentials for BOTH students and managers.

#### For Students (Create 3):

**Student 1:**
```
Document ID: student_oak_001
Fields:
  type: "student"
  enrollmentId: "E123456"
  password: "1999-05-15"          (DOB as password)
  messId: "mess_oak_001"
  name: "Alice Johnson"
  createdAt: (timestamp - auto)
```

**Student 2:**
```
Document ID: student_oak_002
Fields:
  type: "student"
  enrollmentId: "E123457"
  password: "2000-03-22"
  messId: "mess_oak_001"
  name: "Bob Smith"
  createdAt: (timestamp - auto)
```

**Student 3:**
```
Document ID: student_alder_001
Fields:
  type: "student"
  enrollmentId: "E123458"
  password: "2001-07-10"
  messId: "mess_alder_001"
  name: "Carol White"
  createdAt: (timestamp - auto)
```

#### For Managers (Create 2):

**Manager 1:**
```
Document ID: manager_oak_001
Fields:
  type: "manager"
  email: "oak.manager@mess.com"
  password: "oak123456"            (will be stored - consider encrypting later)
  messId: "mess_oak_001"
  name: "Oak Manager"
  createdAt: (timestamp - auto)
```

**Manager 2:**
```
Document ID: manager_alder_001
Fields:
  type: "manager"
  email: "alder.manager@mess.com"
  password: "alder123456"
  messId: "mess_alder_001"
  name: "Alder Manager"
  createdAt: (timestamp - auto)
```

---

### Collection 2: `messes`
Basic mess information.

**Mess 1:**
```
Document ID: mess_oak_001
Fields:
  name: "Oak Mess"
  messCode: "OAK"
  capacity: 200
  managerId: "manager_oak_001"
  location: "Building A"
  createdAt: (timestamp - auto)
```

**Mess 2:**
```
Document ID: mess_alder_001
Fields:
  name: "Alder Mess"
  messCode: "ALDER"
  capacity: 180
  managerId: "manager_alder_001"
  location: "Building B"
  createdAt: (timestamp - auto)
```

---

## Step 2: Firebase Auth Setup (Managers Only)

Go to **Firebase Console → Authentication → Users**

Create 2 accounts:
1. Email: `oak.manager@mess.com` Password: `oak123456`
2. Email: `alder.manager@mess.com` Password: `alder123456`

(Students do NOT need Firebase Auth - they use Enrollment ID + DOB)

---

## Collections That Auto-Generate (Your App Creates These)

### `attendance`
Records when students mark attendance via QR code.

**Structure:**
```
attendance/
  mess_oak_001/
    2024-12-20/              (date)
      breakfast/
        student_oak_001:
          enrollmentId: "E123456"
          studentName: "Alice Johnson"
          markedAt: (timestamp)
          markedBy: "qr"     (only QR marks allowed)
      lunch/
      dinner/
  mess_alder_001/
    2024-12-20/
      breakfast/ (same)
```

**Rule:** Once a student marks attendance for breakfast on 2024-12-20, they CANNOT mark again for breakfast on that same day.

---

### `sessions`
Tracks each meal timing per day.

**Structure:**
```
sessions/
  mess_oak_001/
    2024-12-20:
      breakfast:
        startTime: "07:00"
        endTime: "09:00"
        totalStudents: 150
        presentCount: 95
        createdAt: (timestamp)
```

---

### `qr_codes`
QR codes generated by manager for each meal.

**Structure:**
```
qr_codes/
  mess_oak_001/
    2024-12-20/
      breakfast:
        qrCodeId: "unique_random_id"
        generatedAt: (timestamp)
        expiresAt: (timestamp - 15 mins from generation)
        scannedBy:
          - studentId: "student_oak_001"
            scannedAt: (timestamp)
```

**Note:** Each QR expires after 15 minutes. Manager must generate a new QR for the next batch of students.

---

### `reviews`
Student ratings and comments on meals.

**Structure:**
```
reviews/
  mess_oak_001/
    2024-12-20/
      breakfast:
        student_oak_001:
          rating: 4
          comment: "Good meal"
          submittedAt: (timestamp)
```

---

### `menus`
Daily meal descriptions created by manager.

**Structure:**
```
menus/
  mess_oak_001/
    2024-12-20:
      breakfast:
        - dish: "Bread"
          quantity: "2 slices"
        - dish: "Milk"
          quantity: "1 glass"
      lunch:
        - dish: "Rice"
          quantity: "1 bowl"
```

---

### `predictions`
ML model predictions (generated by Python backend).

**Structure:**
```
predictions/
  mess_oak_001/
    2024-12-21/
      breakfast:
        predictedAttendance: 142
        confidence: 0.85
        generatedAt: (timestamp)
      lunch:
        predictedAttendance: 155
      dinner:
        predictedAttendance: 120
```

---

### `analytics`
Summary statistics (auto-updated after each attendance mark).

**Structure:**
```
analytics/
  mess_oak_001/
    2024-12-20:
      totalStudents: 150
      presentBreakfast: 95
      presentLunch: 110
      presentDinner: 88
      averageRating: 3.8
      lastUpdated: (timestamp)
```

---

## How the App Works

### Student Workflow:
1. **Login:**
   - Enters Enrollment ID: `E123456`
   - Enters DOB (password): `1999-05-15`
   - App searches `loginCredentials` collection
   - Finds matching record → Loads their `messId` → Shows their mess dashboard

2. **Mark Attendance:**
   - Scans QR code generated by manager
   - App checks: Does `attendance/mess_oak_001/2024-12-20/breakfast/student_oak_001` exist?
   - If NO → Creates it → Shows "✓ Marked Present"
   - If YES → Shows "❌ Already marked for this meal today"

3. **Submit Review:**
   - Sees meal dishes from `menus/mess_oak_001/2024-12-20/breakfast`
   - Rates each dish (1-5 stars)
   - App creates record in `reviews/mess_oak_001/2024-12-20/breakfast/student_oak_001`

4. **View Prediction:**
   - App reads `predictions/mess_oak_001/2024-12-21/breakfast`
   - Shows: "We predict ~142 students for breakfast tomorrow"

### Manager Workflow:
1. **Login:**
   - Enters Email: `oak.manager@mess.com`
   - Enters Password: `oak123456`
   - App searches `loginCredentials` and Firebase Auth
   - Loads their assigned mess(es) from `messId`

2. **Generate QR:**
   - Clicks "Generate QR for Breakfast"
   - App creates new record in `qr_codes/mess_oak_001/2024-12-20/breakfast`
   - QR code displayed (students scan this)
   - QR expires in 15 minutes → Manager generates new one

3. **Create Menu:**
   - Fills in dishes for breakfast/lunch/dinner
   - App creates record in `menus/mess_oak_001/2024-12-20`

4. **View Attendance:**
   - Clicks "Breakfast Attendance"
   - App reads `attendance/mess_oak_001/2024-12-20/breakfast`
   - Shows all students who marked: Alice ✓, Bob ✓, Carol ✗

5. **Mark Manually:**
   - If a student didn't scan QR, manager can manually add them
   - Creates record in `attendance/mess_oak_001/2024-12-20/breakfast/student_id`
   - Same path = same rules apply (can't mark twice)

6. **View Analytics:**
   - Sees summary from `analytics/mess_oak_001/2024-12-20`
   - Breakfast: 95/150 present, Rating: 4.2⭐

---

## Duplicate Prevention (Critical)

**Once marked, CANNOT mark again:**
```
If student_oak_001 marks breakfast on 2024-12-20:
  Path created: attendance/mess_oak_001/2024-12-20/breakfast/student_oak_001

Next time student tries to mark breakfast on 2024-12-20:
  App checks if path exists
  Path EXISTS → Show error: "Already marked attendance for breakfast today"
  Student BLOCKED from marking again
```

This prevents double-counting.

---

## Mess Isolation (Every Collection)

All data is organized by `messId`. Complete isolation:

**OAK Mess Students:**
- Can only see: `attendance/mess_oak_001`, `menus/mess_oak_001`, `reviews/mess_oak_001`, etc.
- Cannot see ALDER mess data

**ALDER Mess Students:**
- Can only see: `attendance/mess_alder_001`, `menus/mess_alder_001`, etc.
- Cannot see OAK mess data

**Manager:**
- Logs in with their `messId`
- Can only manage their assigned mess

---

## Checklist

### ✅ YOU CREATE (Manual):
- [ ] `loginCredentials` collection
  - [ ] 3 student records
  - [ ] 2 manager records
- [ ] `messes` collection
  - [ ] mess_oak_001
  - [ ] mess_alder_001
- [ ] Firebase Auth accounts
  - [ ] oak.manager@mess.com
  - [ ] alder.manager@mess.com

### ✅ APP AUTO-CREATES (When Running):
- [ ] `attendance` - when student marks
- [ ] `sessions` - when meal starts
- [ ] `qr_codes` - when manager generates QR
- [ ] `reviews` - when student reviews
- [ ] `menus` - when manager creates menu
- [ ] `predictions` - when backend generates
- [ ] `analytics` - auto-updated

---

## Testing Login

**Test Student 1:**
- Enrollment ID: `E123456`
- DOB: `1999-05-15`
- Expected Mess: Oak Mess (mess_oak_001)

**Test Student 2:**
- Enrollment ID: `E123457`
- DOB: `2000-03-22`
- Expected Mess: Oak Mess (mess_oak_001)

**Test Student 3:**
- Enrollment ID: `E123458`
- DOB: `2001-07-10`
- Expected Mess: Alder Mess (mess_alder_001)

**Test Manager 1:**
- Email: `oak.manager@mess.com`
- Password: `oak123456`
- Expected Mess: Oak Mess (mess_oak_001)

**Test Manager 2:**
- Email: `alder.manager@mess.com`
- Password: `alder123456`
- Expected Mess: Alder Mess (mess_alder_001)

---

## Next Steps After Setup

1. Create the manual collections above in Firestore
2. Create Firebase Auth accounts for managers
3. Run the Flutter app: `flutter run -d edge` or `flutter build web --release`
4. Test student login with test data
5. Test manager login with test data
6. Once working, implement:
   - Manager home screen (QR generation, menu creation)
   - Student home screen (QR scanning, meal review)
   - Analytics dashboard
   - ML predictions integration
